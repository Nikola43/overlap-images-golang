package main

import (
	"encoding/json"
	"fmt"
	"image"
	"image/png"
	"log"
	"math/rand"
	"os"
	"path/filepath"
	"strconv"
	"strings"
	"time"

	_ "image/png"
)

type MetadataField struct {
	Item   string
	Rarity string
}

type Baby struct {
	Filename    string
	Backgrounds string
	Clothes     MetadataField
	Dummys      MetadataField
	Hairs       MetadataField
	Hats        MetadataField
	Objects     MetadataField
	Skins       MetadataField
	Rarity      float64
}

func UnmarshalBaby(data []byte) (Baby, error) {
	var r Baby
	err := json.Unmarshal(data, &r)
	return r, err
}

func (r *Baby) Marshal() ([]byte, error) {
	return json.Marshal(r)
}

const (
	BASE_PATH  = "Babypunks_Complements"
	Background = BASE_PATH + "/background"
	Clothes    = BASE_PATH + "/clothes"
	Dummy      = BASE_PATH + "/dummy"
	Hair       = BASE_PATH + "/hair"
	Hats       = BASE_PATH + "/hats"
	Objects    = BASE_PATH + "/objects"
	Skin       = BASE_PATH + "/skin"
)

func main() {
	/*
		rarityPercent := map[string]int{
			"common":   50,
			"uncommon": 28,
			"rare":     15,
			"mythical": 5,
			"legend":   2,
		}
	*/

	backgrounds := GetFiles(BASE_PATH + "/background")
	clothes := GetFiles(BASE_PATH + "/clothes")
	dummys := GetFiles(BASE_PATH + "/dummy")
	hairs := GetFiles(BASE_PATH + "/hair")
	hats := GetFiles(BASE_PATH + "/hats")
	objects := GetFiles(BASE_PATH + "/objects")
	skins := GetFiles(BASE_PATH + "/skin")

	fmt.Println(backgrounds)
	fmt.Println(clothes)
	fmt.Println(dummys)
	fmt.Println(hairs)
	fmt.Println(hats)
	fmt.Println(objects)
	fmt.Println(skins)

	babys := make([]*Baby, 0)

	for i := 0; i < 10000; i++ {

		var background image.Image
		var clothe image.Image
		var dummy image.Image
		var hair image.Image
		var hat image.Image
		var object image.Image
		var skin image.Image

		var gerror error

		b := backgrounds[GenerateRandomNumber(0, len(backgrounds)-1)]
		background, gerror = openImage(b)
		if gerror != nil {
			panic(gerror)
			return
		}

		c := clothes[GenerateRandomNumber(0, len(clothes)-1)]
		clothe, gerror = openImage(c)
		if gerror != nil {
			panic(gerror)
			return
		}

		d := dummys[GenerateRandomNumber(0, len(dummys)-1)]
		dummy, gerror = openImage(d)
		if gerror != nil {
			panic(gerror)
			return
		}

		h := hairs[GenerateRandomNumber(0, len(hairs)-1)]
		hair, gerror = openImage(h)
		if gerror != nil {
			panic(gerror)
			return
		}

		hh := hats[GenerateRandomNumber(0, len(hats)-1)]
		hat, gerror = openImage(hh)
		if gerror != nil {
			panic(gerror)
			return
		}

		o := objects[GenerateRandomNumber(0, len(objects)-1)]
		object, gerror = openImage(o)
		if gerror != nil {
			panic(gerror)
			return
		}

		s := skins[GenerateRandomNumber(0, len(skins)-1)]
		skin, gerror = openImage(s)
		if gerror != nil {
			panic(gerror)
			return
		}

		imgs := []ImageLayer{
			{
				Image: background,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: skin,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: clothe,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: object,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: dummy,
				XPos:  0,
				YPos:  0,
			},
		}

		if GenerateRandomNumber(1, 2) == 1 {
			imgs = append(imgs, ImageLayer{
				Image: hair,
				XPos:  0,
				YPos:  0,
			})
		} else {
			imgs = append(imgs, ImageLayer{
				Image: hat,
				XPos:  0,
				YPos:  0,
			})
		}

		res, err := GenerateBanner(imgs)
		if err != nil {
			log.Printf("Error generating banner: %+v\n", err)
		}

		counterString := strconv.Itoa(i)
		f, _ := os.Create("generated/baby_" + counterString + ".png")
		png.Encode(f, res)

		baby := new(Baby)
		baby.Filename = "generated/baby_" + counterString + ".png"

		baby.Backgrounds = GetObjectName(b)

		baby.Clothes.Item = GetObjectName(c)
		baby.Clothes.Rarity = GetObjectRarity(c)

		baby.Dummys.Item = GetObjectName(d)
		baby.Dummys.Rarity = GetObjectRarity(d)

		baby.Hairs.Item = GetObjectName(h)
		baby.Hairs.Rarity = GetObjectRarity(h)

		baby.Hats.Item = GetObjectName(hh)
		baby.Hats.Rarity = GetObjectRarity(hh)

		baby.Objects.Item = GetObjectName(o)
		baby.Objects.Rarity = GetObjectRarity(o)

		baby.Skins.Item = GetObjectName(s)
		baby.Skins.Rarity = GetObjectRarity(s)

		babys = append(babys, baby)

		fmt.Println()

		log.Println("Banner Generated")
	}

	j, _ := json.Marshal(babys)

	//bytes, _ := babys.Marshal()

	// to append to a file
	// create the file if it doesn't exists with O_CREATE, Set the file up for read write, add the append flag and set the permission
	f, errr := os.OpenFile("file.json", os.O_CREATE|os.O_RDWR|os.O_APPEND, 0660)
	defer f.Close()
	if errr != nil {
		log.Fatal(errr)
	}
	// write to file, f.Write()
	f.Write(j)

	/*

		background, err := openImage(Background+"")
		if err != nil {
			log.Println(err)
			return
		}

		object_cetro, err := openImage("images/object_cetro.png")
		if err != nil {
			log.Println(err)
			return
		}

		baby, err := openImage("images/background_red.png")
		if err != nil {
			log.Println(err)
			return
		}

		dummy_diamond, err := openImage("images/dummy_diamond.png")
		if err != nil {
			log.Println(err)
			return
		}

		hair_curly, err := openImage("images/hair_curly.png")
		if err != nil {
			log.Println(err)
			return
		}

		clothes_swit, err := openImage("images/clothes_swit.png")
		if err != nil {
			log.Println(err)
			return
		}

		imgs := []bannergenerator.ImageLayer{
			{
				Image: background,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: baby,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: object_cetro,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: dummy_diamond,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: hair_curly,
				XPos:  0,
				YPos:  0,
			},
			{
				Image: clothes_swit,
				XPos:  0,
				YPos:  0,
			},
		}



		res, err := bannergenerator.GenerateBanner(imgs)
		if err != nil {
			log.Printf("Error generating banner: %+v\n", err)
		}


		f, _ := os.Create("image.png")
		png.Encode(f, res)

		log.Println("Banner Generated")
	*/
}

func GetObjectName(object string) string {
	s := strings.Split(object, "/")
	objectName := s[len(s)-1]
	objectName = strings.Replace(objectName, ".png", "", 4)
	return objectName
}

func GetObjectRarity(object string) string {

	if strings.Contains(object, "uncommon") {
		return "uncommon"
	}

	if strings.Contains(object, "common") {
		return "common"
	}

	if strings.Contains(object, "rare") {
		return "rare"
	}

	if strings.Contains(object, "mythical") {
		return "mythical"
	}

	if strings.Contains(object, "legend") {
		return "legend"
	}

	return ""
}

func openImage(path string) (image.Image, error) {
	var file, err = os.OpenFile(path, os.O_RDWR, 0644)
	if err != nil {
		return nil, err
	}
	defer file.Close()

	imageFile, _, err := image.Decode(file)
	if err != nil {
		return nil, err
	}

	return imageFile, err
}

func GetFiles(root string) []string {
	var files []string

	err := filepath.Walk(root, func(path string, info os.FileInfo, err error) error {
		if strings.Contains(path, ".png") {
			files = append(files, path)
		}
		return nil
	})
	if err != nil {
		panic(err)
	}
	for _, file := range files {
		fmt.Println(file)
	}
	return files
}

func GenerateRandomNumber(min, max int) int {
	rand.Seed(time.Now().UnixNano())
	n := rand.Intn(max-min+1) + min
	fmt.Println(n)

	return n
}
